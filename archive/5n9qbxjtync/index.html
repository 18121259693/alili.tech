<!DOCTYPE html><html lang="zh"><head><meta name="generator" content="Hugo 0.51"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="HandheldFriendly" content="True"><meta name="viewport" content="initial-scale=1,width=device-width,minimum-scale=1,maximum-scale=1,user-scalable=no"><meta name="wap-font-scale" content="no"><meta name="360-site-verification" content="0903ba33c82867d1f7bd8831e32a7e34"><meta name="sogou_site_verification" content="E8uWFBcf4a"><meta name="author" content="Fan"><meta name="description" itemprop="description" content="$(function(){ var html = &#34;\n\x3ch1 id=\x22articleHeader0\x22\x3e\x26#x5F00;\x26#x59CB;\x3c\/h1\x3e\x3cp\x3e\x26#x5728;\x26#x51FD;\x26#x6570;\x26#x5F0F;\x26#x7F16;\x26#x7A0B;\x26#x4E2D;\x26#xFF0C;Immut"><meta name="keywords" content="Alili, 前端大爆炸, WEB BANG BANG BANG, web前端博客, 前端模块化, 前端工程化, 前端数据监控, 性能优化, 网页制作, 前端, js, html5, css, 踩坑小报告, 微前端, 树莓派, 前端开发, 区块链, 网络, Mongodb, Vue.js, Angular.js, node.js"><meta property="og:locale" content="en_US"><meta property="og:title" content="Immer.js简析"><meta property="og:image" content="https://alili.tech/images/logo2.png"><meta property="og:description" content="$(function(){ var html = &#34;\n\x3ch1 id=\x22articleHeader0\x22\x3e\x26#x5F00;\x26#x59CB;\x3c\/h1\x3e\x3cp\x3e\x26#x5728;\x26#x51FD;\x26#x6570;\x26#x5F0F;\x26#x7F16;\x26#x7A0B;\x26#x4E2D;\x26#xFF0C;Immut"><meta property="og:site_name" content="Alili"><title>Immer.js简析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!</title><link rel="shortcut icon" href="https://alili.tech/images/favicon.ico"><link rel="manifest" href="/manifest.json"><link rel="stylesheet" href="https://alili.tech/lib/font-awesome/css/font-awesome.min.css"><link rel="stylesheet" href="https://alili.tech/lib/justified-gallery/justifiedGallery.min.css"><link rel="stylesheet" href="https://alili.tech/css/style.css"><script src="https://alili.tech/lib/highlight.min.js"></script><script>hljs.initHighlightingOnLoad()</script><script src="https://alili.tech/lib/jquery/jquery.min.js"></script><script>document.addEventListener("error",function(e){var t=e.target;"img"==t.tagName.toLowerCase()&&(t.style.display="none")},!0)</script><script type="application/ld+json">{
				"@context": "https://ziyuan.baidu.com/contexts/cambrian.jsonld",
				"@id": "https://alili.tech/archive/5n9qbxjtync/",
				"appid": "1613049289050283", 
				"title": "Immer.js简析 | 前端大爆炸! - WEB BANG! BANG!! BANG!!!", 
				"images": [],
				"pubDate": "2018-11-25T02:30:08"
			}</script></head><body><div id="header-post"><a id="menu-icon" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="menu-icon-tablet" href="#"><i class="fa fa-bars fa-lg"></i></a> <a id="top-icon-tablet" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")' style="display:none"><i class="fa fa-chevron-up fa-lg"></i></a> <span id="menu"><span id="nav"><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></span><br><span id="actions"><ul><li><a class="icon" href="https://alili.tech/archive/bfx65io8kzq/"><i class="fa fa-chevron-left" aria-hidden="true" onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class="icon" href="https://alili.tech/archive/rammpgaedbn/"><i class="fa fa-chevron-right" aria-hidden="true" onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class="icon" href="#" onclick='$("html, body").animate({scrollTop:0},"fast")'><i class="fa fa-chevron-up" aria-hidden="true" onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class="icon" href="#"><i class="fa fa-share-alt" aria-hidden="true" onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id="i-prev" class="info" style="display:none">Previous post</span> <span id="i-next" class="info" style="display:none">Next post</span> <span id="i-top" class="info" style="display:none">Back to top</span> <span id="i-share" class="info" style="display:none">Share post</span></span><br><div id="share" style="display:none"><ul><li><a class="icon" href="http://v.t.sina.com.cn/share/share.php?u=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&text=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-weibo" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f"><i class="fa fa-facebook" aria-hidden="true"></i></a></li><li><a class="icon" href="https://twitter.com/share?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&text=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-twitter" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&title=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-linkedin" aria-hidden="true"></i></a></li><li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&is_video=false&description=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-pinterest" aria-hidden="true"></i></a></li><li><a class="icon" href="mailto:?subject=Immer.js%e7%ae%80%e6%9e%90&body=Check out this article: https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f"><i class="fa fa-envelope" aria-hidden="true"></i></a></li><li><a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&title=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-get-pocket" aria-hidden="true"></i></a></li><li><a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&title=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-reddit" aria-hidden="true"></i></a></li><li><a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&title=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-stumbleupon" aria-hidden="true"></i></a></li><li><a class="icon" href="http://digg.com/submit?url=https%3a%2f%2falili.tech%2farchive%2f5n9qbxjtync%2f&title=Immer.js%e7%ae%80%e6%9e%90"><i class="fa fa-digg" aria-hidden="true"></i></a></li></ul></div><div id="toc"><nav id="TableOfContents"><ul><li><a href="#版权声明">版权声明</a><ul><li><a href="#原文标题">原文标题</a></li><li><a href="#原文链接">原文链接</a></li></ul></li></ul></nav></div></span></div><div class="content index width mx-auto px3 my3"><section id="wrapper" class="home"><article class="post" itemscope itemtype="http://schema.org/BlogPosting"><header><h1 class="posttitle" itemprop="name headline">Immer.js简析</h1><div class="meta"><div class="postdate"><time datetime="2018-11-25" itemprop="datePublished">2018-11-25</time></div><div class="article-tag"><i class="fa fa-eye"></i> <span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span></span></div><div class="article-tag-box"></div></div></header><div class="content" itemprop="articleBody"><div id="raw"><script>$(function(){var x='\n<h1 id="articleHeader0">&#x5F00;&#x59CB;</h1><p>&#x5728;&#x51FD;&#x6570;&#x5F0F;&#x7F16;&#x7A0B;&#x4E2D;&#xFF0C;Immutable&#x8FD9;&#x4E2A;&#x7279;&#x6027;&#x662F;&#x76F8;&#x5F53;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x4F46;&#x662F;&#x5728;Javascript&#x4E2D;&#x5F88;&#x660E;&#x663E;&#x662F;&#x6CA1;&#x529E;&#x6CD5;&#x4ECE;&#x8BED;&#x8A00;&#x5C42;&#x9762;&#x63D0;&#x4F9B;&#x652F;&#x6301;&#xFF0C;&#x4F46;&#x662F;&#x8FD8;&#x6709;&#x5176;&#x4ED6;&#x5E93;(&#x4F8B;&#x5982;&#xFF1A;Immutable.js)&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x7ED9;&#x5F00;&#x53D1;&#x8005;&#x7528;&#x4E0A;&#x8FD9;&#x6837;&#x7684;&#x7279;&#x6027;&#xFF0C;&#x6240;&#x4EE5;&#x4E00;&#x76F4;&#x5F88;&#x597D;&#x5947;&#x8FD9;&#x4E9B;&#x5E93;&#x662F;&#x600E;&#x4E48;&#x5B9E;&#x73B0;Immutable&#x7684;&#xFF0C;&#x8FD9;&#x6B21;&#x5C31;&#x4ECE;Immer.js&#xFF08;&#x5C0F;&#x5DE7;&#x73B2;&#x73D1;&#xFF09;&#x5165;&#x624B;&#x770B;&#x770B;&#x5185;&#x90E8;&#x662F;&#x600E;&#x4E48;&#x505A;&#x7684;&#x3002;</p><h1 id="articleHeader1">Copy On Write&#xFF08;&#x5199;&#x65F6;&#x590D;&#x5236;&#xFF09;</h1><p>&#x7B2C;&#x4E00;&#x6B21;&#x4E86;&#x89E3;&#x5230;&#x8FD9;&#x6837;&#x7684;&#x6280;&#x672F;&#x8FD8;&#x662F;&#x5728;&#x5B66;Java&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x4E2A;&#x8BCD;&#x4E5F;&#x662F;&#x5F88;&#x597D;&#x7406;&#x89E3;&#xFF1A;&#x51C6;&#x5907;&#x4FEE;&#x6539;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5148;&#x590D;&#x5236;&#x4E00;&#x4EFD;&#x518D;&#x53BB;&#x4FEE;&#x6539;&#xFF1B;&#x8FD9;&#x6837;&#x5C31;&#x80FD;&#x907F;&#x514D;&#x76F4;&#x63A5;&#x4FEE;&#x6539;&#x672C;&#x4F53;&#x6570;&#x636E;&#xFF0C;&#x4E5F;&#x80FD;&#x628A;&#x6027;&#x80FD;&#x5F71;&#x54CD;&#x6700;&#x5C0F;&#x5316;&#xFF08;&#x4E0D;&#x4FEE;&#x6539;&#x5C31;&#x4E0D;&#x7528;&#x590D;&#x5236;&#x4E86;&#x561B;&#xFF09;&#xFF1B;&#x5728;Immer.js&#x91CC;&#x9762;&#x4E5F;&#x662F;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x6280;&#x672F;&#xFF0C;&#x800C;Immer.js&#x7684;&#x57FA;&#x672C;&#x601D;&#x60F3;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p><blockquote>The basic idea is that you will apply all your changes to a temporarily draftState, which is a proxy of the currentState. Once all your mutations are completed, Immer will produce the nextState based on the mutations to the draft state. This means that you can interact with your data by simply modifying it, while keeping all the benefits of immutable data.</blockquote><p>&#x4E2A;&#x4EBA;&#x7B80;&#x5355;&#x7FFB;&#x8BD1;&#x4E00;&#x4E0B;&#xFF1A;&#x4E3B;&#x8981;&#x601D;&#x60F3;&#x5C31;&#x662F;&#x5148;&#x5728;currentState&#x57FA;&#x7840;&#x4E0A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x4EE3;&#x7406;draftState&#xFF0C;&#x4E4B;&#x540E;&#x7684;&#x6240;&#x6709;&#x4FEE;&#x6539;&#x90FD;&#x4F1A;&#x5728;draftState&#x4E0A;&#x8FDB;&#x884C;&#xFF0C;&#x907F;&#x514D;&#x76F4;&#x63A5;&#x4FEE;&#x6539;currentState&#xFF0C;&#x800C;&#x5F53;&#x4FEE;&#x6539;&#x7ED3;&#x675F;&#x540E;&#xFF0C;&#x518D;&#x4ECE;draftState&#x57FA;&#x7840;&#x4E0A;&#x751F;&#x6210;nextState&#x3002;&#x6240;&#x4EE5;&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#x53EA;&#x6D89;&#x53CA;&#x4E09;&#x4E2A;State&#xFF1A;currentState&#xFF08;&#x8F93;&#x5165;&#x72B6;&#x6001;&#xFF09;&#xFF0C;draftState&#xFF08;&#x4E2D;&#x95F4;&#x72B6;&#x6001;&#xFF09;&#xFF0C;nextState&#xFF08;&#x8F93;&#x51FA;&#x72B6;&#x6001;&#xFF09;&#xFF1B;&#x5173;&#x952E;&#x662F;draftState&#x662F;&#x5982;&#x4F55;&#x751F;&#x6210;&#xFF0C;&#x5982;&#x4F55;&#x5E94;&#x7528;&#x4FEE;&#x6539;&#xFF0C;&#x5982;&#x4F55;&#x751F;&#x6210;&#x6700;&#x7EC8;&#x7684;nextState&#x3002;</p><h1 id="articleHeader2">&#x5206;&#x6790;&#x6E90;&#x7801;</h1><p>&#x56E0;&#x4E3A;Immer.js&#x786E;&#x5B9E;&#x975E;&#x5E38;&#x5C0F;&#x5DE7;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x4ECE;&#x6838;&#x5FC3;API&#x51FA;&#x53D1;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="const nextState = produce(baseState, draftState =&gt; {\n    draftState.push({todo: &quot;Tweet about it&quot;})\n    draftState[1].done = true\n})" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs nix"><code>const <span class="hljs-attr">nextState</span> = produce(baseState, <span class="hljs-attr">draftState</span> =&gt; {\n    draftState.push({todo: <span class="hljs-string">&quot;Tweet about it&quot;</span>})\n    draftState[<span class="hljs-number">1</span>].<span class="hljs-attr">done</span> = <span class="hljs-literal">true</span>\n})</code></pre><p>&#x5728;&#x4E0A;&#x9762;produce&#x65B9;&#x6CD5;&#x5C31;&#x5305;&#x62EC;&#x521A;&#x624D;&#x8BF4;&#x7684;currentState-&gt;draftState-&gt;nextState&#x6574;&#x4E2A;&#x8FC7;&#x7A0B;&#xFF0C;&#x7136;&#x540E;&#x6DF1;&#x5165;produce&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="export default function produce(baseState, producer) {\n    ...\n    return getUseProxies()\n        ? produceProxy(baseState, producer)\n        : produceEs5(baseState, producer)\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs ada"><code>export default <span class="hljs-keyword">function</span> <span class="hljs-title">produce</span>(baseState, producer) {\n    ...\n    <span class="hljs-keyword">return</span> <span class="hljs-type">getUseProxies()</span>\n        ? produceProxy(baseState, producer)\n        : <span class="hljs-type">produceEs5</span>(baseState, producer)\n}</code></pre><p>Immer.js&#x4F1A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;ES6&#x7684;Proxy&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x53EA;&#x80FD;&#x4F7F;&#x7528;ES5&#x7684;&#x65B9;&#x5F0F;&#x53BB;&#x5B9E;&#x73B0;&#x4EE3;&#x7406;&#xFF08;&#x5F53;&#x7136;&#x4E5F;&#x662F;&#x4F1A;&#x9EBB;&#x70E6;&#x4E00;&#x70B9;&#xFF09;&#xFF0C;&#x8FD9;&#x91CC;&#x5148;&#x4ECE;ES6&#x7684;Proxy&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x5F00;&#x59CB;&#x5206;&#x6790;&#xFF0C;&#x540E;&#x9762;&#x518D;&#x56DE;&#x5934;&#x5206;&#x6790;&#x4E00;&#x4E0B;ES5&#x7684;&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x3002;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="export function produceProxy(baseState, producer) {\n    const previousProxies = proxies // 1.&#x5907;&#x4EFD;&#x5F53;&#x524D;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;\n    proxies = []\n    try {  \n        const rootProxy = createProxy(undefined, baseState) // 2.&#x521B;&#x5EFA;&#x4EE3;&#x7406;\n        const returnValue = producer.call(rootProxy, rootProxy) // 3.&#x5E94;&#x7528;&#x4FEE;&#x6539;\n        let result\n        if (returnValue !== undefined &amp;&amp; returnValue !== rootProxy) {\n            if (rootProxy[PROXY_STATE].modified)\n                throw new Error(RETURNED_AND_MODIFIED_ERROR)\n            result = finalize(returnValue) // 4.&#x751F;&#x6210;&#x5BF9;&#x8C61;\n        } else {\n            result = finalize(rootProxy) // 5.&#x751F;&#x6210;&#x5BF9;&#x8C61;\n        }\n        each(proxies, (_, p) =&gt; p.revoke()) // 6.&#x6CE8;&#x9500;&#x5F53;&#x524D;&#x6240;&#x6709;&#x4EE3;&#x7406;\n        return result\n    } finally {\n        proxies = previousProxies // 7.&#x6062;&#x590D;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;\n    }\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs typescript"><code><span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">produceProxy</span>(<span class="hljs-params">baseState, producer</span>) </span>{\n    <span class="hljs-keyword">const</span> previousProxies = proxies <span class="hljs-comment">// 1.&#x5907;&#x4EFD;&#x5F53;&#x524D;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>\n    proxies = []\n    <span class="hljs-keyword">try</span> {  \n        <span class="hljs-keyword">const</span> rootProxy = createProxy(<span class="hljs-literal">undefined</span>, baseState) <span class="hljs-comment">// 2.&#x521B;&#x5EFA;&#x4EE3;&#x7406;</span>\n        <span class="hljs-keyword">const</span> returnValue = producer.call(rootProxy, rootProxy) <span class="hljs-comment">// 3.&#x5E94;&#x7528;&#x4FEE;&#x6539;</span>\n        <span class="hljs-keyword">let</span> result\n        <span class="hljs-keyword">if</span> (returnValue !== <span class="hljs-literal">undefined</span> &amp;&amp; returnValue !== rootProxy) {\n            <span class="hljs-keyword">if</span> (rootProxy[PROXY_STATE].modified)\n                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(RETURNED_AND_MODIFIED_ERROR)\n            result = finalize(returnValue) <span class="hljs-comment">// 4.&#x751F;&#x6210;&#x5BF9;&#x8C61;</span>\n        } <span class="hljs-keyword">else</span> {\n            result = finalize(rootProxy) <span class="hljs-comment">// 5.&#x751F;&#x6210;&#x5BF9;&#x8C61;</span>\n        }\n        each(proxies, <span class="hljs-function">(<span class="hljs-params">_, p</span>) =&gt;</span> p.revoke()) <span class="hljs-comment">// 6.&#x6CE8;&#x9500;&#x5F53;&#x524D;&#x6240;&#x6709;&#x4EE3;&#x7406;</span>\n        <span class="hljs-keyword">return</span> result\n    } <span class="hljs-keyword">finally</span> {\n        proxies = previousProxies <span class="hljs-comment">// 7.&#x6062;&#x590D;&#x4E4B;&#x524D;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;</span>\n    }\n}</code></pre><p>&#x8FD9;&#x91CC;&#x628A;&#x5173;&#x952E;&#x7684;&#x6B65;&#x9AA4;&#x6CE8;&#x91CA;&#x4E00;&#x4E0B;&#xFF0C;&#x7B2C;1&#x6B65;&#x548C;&#x7B2C;6&#xFF0C;7&#x6B65;&#x662F;&#x6709;&#x5173;&#x8054;&#x7684;&#xFF0C;&#x4E3B;&#x8981;&#x4E3A;&#x4E86;&#x5E94;&#x5BF9;&#x5D4C;&#x5957;&#x7684;&#x573A;&#x666F;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="const nextStateA = produce(baseStateA, draftStateA =&gt; {\n    draftStateA[1].done = true;\n    const nextStateB = produce(baseStateB, draftStateB =&gt; {\n        draftStateB[1].done = true\n    });\n})" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs nix"><code>const <span class="hljs-attr">nextStateA</span> = produce(baseStateA, <span class="hljs-attr">draftStateA</span> =&gt; {\n    draftStateA[<span class="hljs-number">1</span>].<span class="hljs-attr">done</span> = <span class="hljs-literal">true</span>;\n    const <span class="hljs-attr">nextStateB</span> = produce(baseStateB, <span class="hljs-attr">draftStateB</span> =&gt; {\n        draftStateB[<span class="hljs-number">1</span>].<span class="hljs-attr">done</span> = <span class="hljs-literal">true</span>\n    });\n})</code></pre><p>&#x56E0;&#x4E3A;&#x6BCF;&#x4E2A;produce&#x65B9;&#x6CD5;&#x6700;&#x540E;&#x90FD;&#x8981;&#x6CE8;&#x9500;&#x6240;&#x6709;&#x4EE3;&#x7406;&#xFF0C;&#x9632;&#x6B62;produce&#x4E4B;&#x540E;&#x4ECD;&#x7136;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x4FEE;&#x6539;&#xFF08;&#x56E0;&#x4E3A;&#x5728;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4E0A;&#x4FEE;&#x6539;&#x6700;&#x7EC8;&#x8FD8;&#x662F;&#x4F1A;&#x6620;&#x5C04;&#x5230;&#x751F;&#x6210;&#x7684;&#x5BF9;&#x8C61;&#x4E0A;&#xFF09;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x6BCF;&#x6B21;&#x90FD;&#x9700;&#x8981;&#x5907;&#x4EFD;&#x4E00;&#x4E0B;proxies&#xFF0C;&#x4EE5;&#x4FBF;&#x4E4B;&#x540E;&#x6CE8;&#x9500;&#x3002;</p><p>&#x7B2C;2&#x6B65;&#xFF0C;&#x521B;&#x5EFA;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#xFF08;&#x6838;&#x5FC3;&#xFF09;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function createProxy(parentState, base) {\n    if (isProxy(base)) throw new Error(&quot;Immer bug. Plz report.&quot;)\n    const state = createState(parentState, base)\n    const proxy = Array.isArray(base)\n        ? Proxy.revocable([state], arrayTraps)\n        : Proxy.revocable(state, objectTraps)\n    proxies.push(proxy)\n    return proxy.proxy\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function createProxy(parentState, base) {\n    if (isProxy(base)) throw new Error(<span class="hljs-string">&quot;Immer bug. Plz report.&quot;</span>)\n    const <span class="hljs-keyword">state</span> = createState(parentState, base)\n    const proxy = Array.isArray(base)\n        ? Proxy.revocable([<span class="hljs-keyword">state</span>], arrayTraps)\n        : Proxy.revocable(<span class="hljs-keyword">state</span>, objectTraps)\n    proxies.push(proxy)\n    return proxy.proxy\n}</code></pre><p>&#x8FD9;&#x91CC;Immer.js&#x4F1A;&#x4F7F;&#x7528;crateState&#x65B9;&#x6CD5;&#x5C01;&#x88C5;&#x4E00;&#x4E0B;&#x6211;&#x4EEC;&#x4F20;&#x5165;&#x7684;&#x6570;&#x636E;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="{\n    modified: false, //&#x662F;&#x5426;&#x4FEE;&#x6539;\n    finalized: false, //&#x662F;&#x5426;finalized\n    parent, //&#x7236;state\n    base, //&#x81EA;&#x8EAB;state\n    copy: undefined, //&#x62F7;&#x8D1D;&#x540E;&#x7684;state\n    proxies: {} //&#x5B58;&#x653E;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>{\n    modified: false, //&#x662F;&#x5426;&#x4FEE;&#x6539;\n    finalized: false, //&#x662F;&#x5426;finalized\n    parent, //&#x7236;<span class="hljs-keyword">state</span>\n    base, //&#x81EA;&#x8EAB;<span class="hljs-keyword">state</span>\n    copy: undefined, //&#x62F7;&#x8D1D;&#x540E;&#x7684;<span class="hljs-keyword">state</span>\n    proxies: {} //&#x5B58;&#x653E;&#x751F;&#x6210;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;\n}</code></pre><p>&#x7136;&#x540E;&#x5C31;&#x662F;&#x6839;&#x636E;&#x6570;&#x636E;&#x662F;&#x5426;&#x662F;&#x5BF9;&#x8C61;&#x8FD8;&#x662F;&#x6570;&#x7EC4;&#x6765;&#x751F;&#x6210;&#x5BF9;&#x5E94;&#x7684;&#x4EE3;&#x7406;&#xFF0C;&#x4EE5;&#x4E0B;&#x662F;&#x4EE3;&#x7406;&#x6240;&#x62E6;&#x622A;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="const objectTraps = {\n    get,\n    has(target, prop) {\n        return prop in source(target)\n    },\n    ownKeys(target) {\n        return Reflect.ownKeys(source(target))\n    },\n    set,\n    deleteProperty,\n    getOwnPropertyDescriptor,\n    defineProperty,\n    setPrototypeOf() {\n        throw new Error(&quot;Immer does not support `setPrototypeOf()`.&quot;)\n    }\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs aspectj"><code><span class="hljs-keyword">const</span> objectTraps = {\n    get,\n    has(<span class="hljs-keyword">target</span>, prop) {\n        <span class="hljs-keyword">return</span> prop in source(<span class="hljs-keyword">target</span>)\n    },\n    ownKeys(<span class="hljs-keyword">target</span>) {\n        <span class="hljs-keyword">return</span> Reflect.ownKeys(source(<span class="hljs-keyword">target</span>))\n    },\n    set,\n    deleteProperty,\n    getOwnPropertyDescriptor,\n    defineProperty,\n    setPrototypeOf() {\n        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">&quot;Immer does not support `setPrototypeOf()`.&quot;</span>)\n    }\n}</code></pre><p>&#x6211;&#x4EEC;&#x91CD;&#x70B9;&#x5173;&#x6CE8;get&#x548C;set&#x65B9;&#x6CD5;&#x5C31;&#x884C;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x6700;&#x5E38;&#x7528;&#x7684;&#xFF0C;&#x641E;&#x660E;&#x767D;&#x8FD9;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x57FA;&#x672C;&#x539F;&#x7406;&#x4E5F;&#x641E;&#x660E;&#x767D;Immer.js&#x7684;&#x6838;&#x5FC3;&#x3002;&#x9996;&#x5148;&#x770B;get&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function get(state, prop) {\n    if (prop === PROXY_STATE) return state\n    if (state.modified) {\n        const value = state.copy[prop]\n        if (value === state.base[prop] &amp;&amp; isProxyable(value))\n            return (state.copy[prop] = createProxy(state, value))\n        return value\n    } else {\n        if (has(state.proxies, prop)) return state.proxies[prop]\n        const value = state.base[prop]\n        if (!isProxy(value) &amp;&amp; isProxyable(value))\n            return (state.proxies[prop] = createProxy(state, value))\n        return value\n    }\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function get(<span class="hljs-keyword">state</span>, prop) {\n    if (prop === PROXY_STATE) return <span class="hljs-keyword">state</span>\n    if (<span class="hljs-keyword">state</span>.modified) {\n        const value = <span class="hljs-keyword">state</span>.copy[prop]\n        if (value === <span class="hljs-keyword">state</span>.base[prop] &amp;&amp; isProxyable(value))\n            return (<span class="hljs-keyword">state</span>.copy[prop] = createProxy(<span class="hljs-keyword">state</span>, value))\n        return value\n    } else {\n        if (has(<span class="hljs-keyword">state</span>.proxies, prop)) return <span class="hljs-keyword">state</span>.proxies[prop]\n        const value = <span class="hljs-keyword">state</span>.base[prop]\n        if (!isProxy(value) &amp;&amp; isProxyable(value))\n            return (<span class="hljs-keyword">state</span>.proxies[prop] = createProxy(<span class="hljs-keyword">state</span>, value))\n        return value\n    }\n}</code></pre><p>&#x4E00;&#x5F00;&#x59CB;&#x5982;&#x679C;&#x8BBF;&#x95EE;&#x5C5E;&#x6027;&#x7B49;&#x4E8E;PROXY_STATE&#x8FD9;&#x4E2A;&#x7279;&#x6B8A;&#x503C;&#x7684;&#x8BDD;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x5C01;&#x88C5;&#x8FC7;&#x7684;state&#x672C;&#x8EAB;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x5176;&#x4ED6;&#x5C5E;&#x6027;&#x4F1A;&#x8FD4;&#x56DE;&#x521D;&#x59CB;&#x5BF9;&#x8C61;&#x6216;&#x8005;&#x662F;&#x5B83;&#x7684;&#x62F7;&#x8D1D;&#x4E0A;&#x5BF9;&#x5E94;&#x7684;&#x503C;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x63A5;&#x7740;&#x4F1A;&#x51FA;&#x73B0;&#x4E00;&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x5982;&#x679C;state&#x6CA1;&#x6709;&#x88AB;&#x4FEE;&#x6539;&#x8FC7;&#xFF0C;&#x8BBF;&#x95EE;&#x7684;&#x662F;state.base&#xFF08;&#x521D;&#x59CB;&#x5BF9;&#x8C61;&#xFF09;&#xFF0C;&#x5426;&#x5219;&#x8BBF;&#x95EE;&#x7684;&#x662F;state.copy&#xFF08;&#x56E0;&#x4E3A;&#x4FEE;&#x6539;&#x90FD;&#x4E0D;&#x4F1A;&#x5728;state.base&#x4E0A;&#x8FDB;&#x884C;&#xFF0C;&#x4E00;&#x65E6;&#x4FEE;&#x6539;&#x8FC7;&#xFF0C;&#x53EA;&#x6709;state.copy&#x624D;&#x662F;&#x6700;&#x65B0;&#x7684;&#xFF09;&#xFF1B;&#x8FD9;&#x91CC;&#x4E5F;&#x4F1A;&#x770B;&#x5230;&#x5176;&#x4ED6;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x53EA;&#x6709;&#x8BBF;&#x95EE;&#x5BF9;&#x5E94;&#x7684;&#x5C5E;&#x6027;&#x7684;&#x65F6;&#x5019;&#x624D;&#x4F1A;&#x53BB;&#x5C1D;&#x8BD5;&#x521B;&#x5EFA;&#xFF0C;&#x5C5E;&#x4E8E;&#x201C;&#x61D2;&#x201D;&#x6A21;&#x5F0F;&#x3002;<br>&#x518D;&#x770B;&#x770B;set&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function set(state, prop, value) {\n    if (!state.modified) {\n        if (\n            (prop in state.base &amp;&amp; is(state.base[prop], value)) ||\n            (has(state.proxies, prop) &amp;&amp; state.proxies[prop] === value)\n        )\n            return true\n        markChanged(state)\n    }\n    state.copy[prop] = value\n    return true\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function <span class="hljs-built_in">set</span>(<span class="hljs-keyword">state</span>, prop, value) {\n    if (!<span class="hljs-keyword">state</span>.modified) {\n        if (\n            (prop <span class="hljs-keyword">in</span> <span class="hljs-keyword">state</span>.base &amp;&amp; is(<span class="hljs-keyword">state</span>.base[prop], value)) ||\n            (has(<span class="hljs-keyword">state</span>.proxies, prop) &amp;&amp; <span class="hljs-keyword">state</span>.proxies[prop] === value)\n        )\n            return true\n        markChanged(<span class="hljs-keyword">state</span>)\n    }\n    <span class="hljs-keyword">state</span>.copy[prop] = value\n    return true\n}</code></pre><p>&#x5982;&#x679C;&#x7B2C;&#x4E00;&#x6B21;&#x4FEE;&#x6539;&#x5BF9;&#x8C61;&#xFF0C;&#x76F4;&#x63A5;&#x4F1A;&#x89E6;&#x53D1;markChanged&#x65B9;&#x6CD5;&#xFF0C;&#x628A;&#x81EA;&#x8EAB;&#x7684;modified&#x6807;&#x8BB0;&#x4E3A;true&#xFF0C;&#x63A5;&#x7740;&#x4E00;&#x76F4;&#x5192;&#x6CE1;&#x5230;&#x6839;&#x5BF9;&#x8C61;&#x8C03;&#x7528;markChange&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function markChanged(state) {\n    if (!state.modified) {\n        state.modified = true\n        state.copy = shallowCopy(state.base)\n        // copy the proxies over the base-copy\n        Object.assign(state.copy, state.proxies) // yup that works for arrays as well\n        if (state.parent) markChanged(state.parent)\n    }\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function markChanged(<span class="hljs-keyword">state</span>) {\n    if (!<span class="hljs-keyword">state</span>.modified) {\n        <span class="hljs-keyword">state</span>.modified = true\n        <span class="hljs-keyword">state</span>.copy = shallowCopy(<span class="hljs-keyword">state</span>.base)\n        // copy the proxies over the base-copy\n        Object.assign(<span class="hljs-keyword">state</span>.copy, <span class="hljs-keyword">state</span>.proxies) // yup that works <span class="hljs-keyword">for</span> arrays as well\n        if (<span class="hljs-keyword">state</span>.parent) markChanged(<span class="hljs-keyword">state</span>.parent)\n    }\n}</code></pre><p>&#x9664;&#x4E86;&#x6807;&#x8BB0;modified&#xFF0C;&#x8FD8;&#x505A;&#x53E6;&#x5916;&#x4E00;&#x4EF6;&#x5C31;&#x662F;&#x4ECE;base&#x4E0A;&#x751F;&#x6210;&#x62F7;&#x8D1D;&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x505A;&#x7684;&#x6D45;&#x590D;&#x5236;&#xFF0C;&#x5C3D;&#x91CF;&#x5229;&#x7528;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x6570;&#x636E;&#xFF0C;&#x51CF;&#x5C0F;&#x5185;&#x5B58;&#x6D88;&#x8017;&#xFF0C;&#x8FD8;&#x6709;&#x5C31;&#x662F;&#x628A;proxies&#x4E0A;&#x4E4B;&#x524D;&#x521B;&#x5EFA;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4E5F;&#x590D;&#x5236;&#x8FC7;&#x53BB;&#x3002;&#x6240;&#x4EE5;&#x6700;&#x7EC8;&#x7684;state.copy&#x4E0A;&#x53EF;&#x4EE5;&#x540C;&#x65F6;&#x5305;&#x542B;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x548C;&#x666E;&#x901A;&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x4E4B;&#x540E;&#x7684;&#x8BBF;&#x95EE;&#x4FEE;&#x6539;&#x90FD;&#x76F4;&#x63A5;&#x5728;state.copy&#x4E0A;&#x8FDB;&#x884C;&#x3002;</p><p>&#x5230;&#x8FD9;&#x91CC;&#x5B8C;&#x6210;&#x4E86;&#x521A;&#x5F00;&#x59CB;&#x7684;currentState-&gt;draftState&#x7684;&#x8F6C;&#x6362;&#x4E86;&#xFF0C;&#x4E4B;&#x540E;&#x5C31;&#x662F;draftState-&gt;nextState&#x7684;&#x8F6C;&#x6362;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E4B;&#x524D;&#x6CE8;&#x91CA;&#x7684;&#x7B2C;4&#x6B65;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="result = finalize(returnValue)" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs ini"><code style="word-break:break-word;white-space:initial"><span class="hljs-attr">result</span> = finalize(returnValue)</code></pre><p>&#x518D;&#x770B;&#x770B;finalize&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="export function finalize(base) {\n    if (isProxy(base)) {\n        const state = base[PROXY_STATE]\n        if (state.modified === true) {\n            if (state.finalized === true) return state.copy\n            state.finalized = true\n            return finalizeObject(\n                useProxies ? state.copy : (state.copy = shallowCopy(base)),\n                state\n            )\n        } else {\n            return state.base\n        }\n    }\n    finalizeNonProxiedObject(base)\n    return base\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>export function finalize(base) {\n    if (isProxy(base)) {\n        const <span class="hljs-keyword">state</span> = base[PROXY_STATE]\n        if (<span class="hljs-keyword">state</span>.modified === true) {\n            if (<span class="hljs-keyword">state</span>.finalized === true) return <span class="hljs-keyword">state</span>.copy\n            <span class="hljs-keyword">state</span>.finalized = true\n            return finalizeObject(\n                useProxies ? <span class="hljs-keyword">state</span>.copy : (<span class="hljs-keyword">state</span>.copy = shallowCopy(base)),\n                <span class="hljs-keyword">state</span>\n            )\n        } else {\n            return <span class="hljs-keyword">state</span>.base\n        }\n    }\n    finalizeN<span class="hljs-keyword">on</span>ProxiedObject(base)\n    return base\n}</code></pre><p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x4E3A;&#x7684;&#x662F;&#x4ECE;state.copy&#x4E0A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x56E0;&#x4E3A;&#x521A;&#x624D;&#x4E5F;&#x8BF4;&#x4E86;state.copy&#x4E0A;&#x5F88;&#x6709;&#x53EF;&#x80FD;&#x540C;&#x65F6;&#x5305;&#x542B;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x548C;&#x666E;&#x901A;&#x5BF9;&#x8C61;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x628A;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x90FD;&#x8F6C;&#x6362;&#x6210;&#x666E;&#x901A;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;state.finalized&#x5C31;&#x662F;&#x6807;&#x8BB0;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x8F6C;&#x6362;&#x7684;&#x3002;<br>&#x76F4;&#x63A5;&#x6DF1;&#x5165;finalizeObject&#x65B9;&#x6CD5;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function finalizeObject(copy, state) {\n    const base = state.base\n    each(copy, (prop, value) =&gt; {\n        if (value !== base[prop]) copy[prop] = finalize(value)\n    })\n    return freeze(copy)\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs dockerfile"><code>function finalizeObject(<span class="hljs-keyword">copy</span><span class="bash">, state) {\n</span>    const base = state.base\n    each(<span class="hljs-keyword">copy</span><span class="bash">, (prop, value) =&gt; {\n</span>        if (value !== base[prop]) <span class="hljs-keyword">copy</span><span class="bash">[prop] = finalize(value)\n</span>    })\n    return freeze(<span class="hljs-keyword">copy</span><span class="bash">)\n</span>}</code></pre><p>&#x8FD9;&#x91CC;&#x4E5F;&#x662F;&#x4E00;&#x4E2A;&#x6DF1;&#x5EA6;&#x904D;&#x5386;&#xFF0C;&#x5982;&#x679C;state.copy&#x4E0A;&#x7684;value&#x4E0D;&#x7B49;&#x4E8E;state.base&#x4E0A;&#x7684;&#xFF0C;&#x80AF;&#x5B9A;&#x662F;&#x88AB;&#x4FEE;&#x6539;&#x8FC7;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x76F4;&#x63A5;&#x518D;&#x8DF3;&#x5165;finalize&#x91CC;&#x9762;&#x8FDB;&#x884C;&#x8F6C;&#x6362;&#xFF0C;&#x6700;&#x540E;&#x628A;&#x8F6C;&#x6362;&#x540E;&#x7684;state.copy&#xFF0C;freeze&#x4E00;&#x4E0B;&#xFF0C;&#x4E00;&#x4E2A;&#x65B0;&#x7684;Immutable&#x6570;&#x636E;&#x5C31;&#x8BDE;&#x751F;&#x4E86;&#x3002;<br>&#x800C;&#x53E6;&#x5916;&#x4E00;&#x4E2A;finalizeNonProxiedObject&#x65B9;&#x6CD5;&#xFF0C;&#x76EE;&#x6807;&#x4E5F;&#x662F;&#x67E5;&#x627E;&#x666E;&#x901A;&#x5BF9;&#x8C61;&#x91CC;&#x9762;&#x7684;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x8FDB;&#x884C;&#x8F6C;&#x6362;&#xFF0C;&#x5C31;&#x4E0D;&#x8D34;&#x4EE3;&#x7801;&#x4E86;&#x3002;</p><p>&#x81F3;&#x6B64;&#x57FA;&#x672C;&#x628A;Immer.js&#x4E0A;&#x7684;Proxy&#x6A21;&#x5F0F;&#x89E3;&#x6790;&#x5B8C;&#x6BD5;&#x3002;</p><p>&#x800C;&#x5728;ES5&#x4E0A;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;ES6&#x7684;Proxy&#xFF0C;&#x53EA;&#x80FD;&#x4EFF;&#x9020;&#x4E00;&#x4E0B;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function createProxy(parent, base) {\n    const proxy = shallowCopy(base)\n    each(base, i =&gt; {\n        Object.defineProperty(proxy, &quot;&quot; + i, createPropertyProxy(&quot;&quot; + i))\n    })\n    const state = createState(parent, proxy, base)\n    createHiddenProperty(proxy, PROXY_STATE, state)\n    states.push(state)\n    return proxy\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function createProxy(parent, base) {\n    const proxy = shallowCopy(base)\n    each(base, i =&gt; {\n        Object.defineProperty(proxy, <span class="hljs-string">&quot;&quot;</span> + i, createPropertyProxy(<span class="hljs-string">&quot;&quot;</span> + i))\n    })\n    const <span class="hljs-keyword">state</span> = createState(parent, proxy, base)\n    createHiddenProperty(proxy, PROXY_STATE, <span class="hljs-keyword">state</span>)\n    states.push(<span class="hljs-keyword">state</span>)\n    return proxy\n}</code></pre><p>&#x521B;&#x5EFA;&#x4EE3;&#x7406;&#x7684;&#x65F6;&#x5019;&#x5C31;&#x662F;&#x5148;&#x4ECE;base&#x4E0A;&#x8FDB;&#x884C;&#x6D45;&#x590D;&#x5236;&#xFF0C;&#x7136;&#x540E;&#x4F7F;&#x7528;defineProperty&#x5BF9;&#x8C61;&#x7684;getter&#x548C;setter&#x8FDB;&#x884C;&#x62E6;&#x622A;&#xFF0C;&#x628A;&#x6620;&#x5C04;&#x5230;state.base&#x6216;&#x8005;state.copy&#x4E0A;&#x3002;&#x5176;&#x5B9E;&#x73B0;&#x5728;&#x6CE8;&#x610F;&#x5230;ES5&#x53EA;&#x80FD;&#x5BF9;getter&#x548C;setter&#x8FDB;&#x884C;&#x62E6;&#x622A;&#x5904;&#x7406;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;&#x4EE3;&#x7406;&#x5BF9;&#x8C61;&#x4E0A;&#x5220;&#x9664;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;&#x6216;&#x8005;&#x589E;&#x52A0;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;&#xFF0C;&#x6211;&#x4EEC;&#x4E4B;&#x540E;&#x600E;&#x4E48;&#x53BB;&#x77E5;&#x9053;&#xFF0C;&#x6240;&#x4EE5;Immer.js&#x6700;&#x540E;&#x4F1A;&#x7528;proxy&#x4E0A;&#x7684;&#x5C5E;&#x6027;keys&#x548C;base&#x4E0A;&#x7684;keys&#x505A;&#x4E00;&#x4E2A;&#x5BF9;&#x6BD4;&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x6709;&#x589E;&#x51CF;&#x5C5E;&#x6027;&#xFF1A;</p><div class="widget-codetool" style="display:none"><div class="widget-codetool--inner"><span class="selectCode code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x5168;&#x9009;"></span> <span type="button" class="copyCode code-tool" data-toggle="tooltip" data-placement="top" data-clipboard-text="function hasObjectChanges(state) {\n    const baseKeys = Object.keys(state.base)\n    const keys = Object.keys(state.proxy)\n    return !shallowEqual(baseKeys, keys)\n}" title="" data-original-title="&#x590D;&#x5236;"></span> <span type="button" class="saveToNote code-tool" data-toggle="tooltip" data-placement="top" title="" data-original-title="&#x653E;&#x8FDB;&#x7B14;&#x8BB0;"></span></div></div><pre class="hljs pf"><code>function hasObjectChanges(<span class="hljs-keyword">state</span>) {\n    const baseKeys = Object.keys(<span class="hljs-keyword">state</span>.base)\n    const keys = Object.keys(<span class="hljs-keyword">state</span>.proxy)\n    return !shallowEqual(baseKeys, keys)\n}</code></pre><p>&#x5176;&#x4ED6;&#x8FC7;&#x7A0B;&#x57FA;&#x672C;&#x8DDF;ES6&#x7684;Proxy&#x4E0A;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p><h1 id="articleHeader3">&#x7ED3;&#x675F;</h1><p>Immter.js&#x5B9E;&#x73B0;&#x8FD8;&#x662F;&#x76F8;&#x5F53;&#x5DE7;&#x5999;&#x7684;&#xFF0C;&#x4EE5;&#x540E;&#x53EF;&#x4EE5;&#x5728;&#x72B6;&#x6001;&#x7BA1;&#x7406;&#x4E0A;&#x4F7F;&#x7528;&#x4E00;&#x4E0B;&#x3002;</p>\n';x=(x=(x=(x=x.replace(/"{/g,"{")).replace(/{"/g,"{")).replace(/"}/g,"}")).replace(/}"/g,"}"),$("#raw").html(x),$("button.preview").hide()})</script></div><h1 id="版权声明">版权声明</h1><p>本文资源来源互联网，仅供学习研究使用，版权归该资源的合法拥有者所有，</p><p>本文仅用于学习、研究和交流目的。转载请注明出处、完整链接以及原作者。</p><p>原作者若认为本站侵犯了您的版权，请联系我们，我们会立即删除！</p><h2 id="原文标题">原文标题</h2><p>Immer.js简析</p><h2 id="原文链接">原文链接</h2><p><a href="https://segmentfault.com/a/1190000015426465">https://segmentfault.com/a/1190000015426465</a></p><h2>本文链接：</h2><a href="https://alili.tech/archive/5n9qbxjtync/" target="_blank">https://alili.tech/archive/5n9qbxjtync/</a></div></article><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><div class="blog-post-comments"></div><script>new Valine({el:".blog-post-comments",app_id:"ItyOVb4I33bTwprf3cY6uqMc-gzGzoHsz",app_key:"hLhtmd4tT0qJbyO2SgQ8odya",placeholder:"说点什么?",avatar:"retro",notify:!0,verify:!0})</script><ul id="more-post-list" class="archive readmore"><h3>其他推荐</h3><li><a href="/archive/rg0oddj3fs/">ES6 的解构赋值前每次都创建一个对象吗？会加重 GC 的负担吗？<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/1gdniq6bvo4/">ES6精华：Promise<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/rammpgaedbn/">Git Commit Log的小型团队最佳实践<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/bfx65io8kzq/">React学习笔记知识点整理<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/dsljhf8c52n/">Vue项目中添加锁屏功能<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/q2h23ddajl/">element-ui拆分dialog到子组件<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/4xu8z5japb7/">前端每日实战：65# 视频演示如何用纯 CSS 创作一个摇摇晃晃的 loader<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/xn012ye2bug/">基于webpack4搭建的react项目框架<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/i04wvbwehrd/">快速实现一个简单的canvas迷宫游戏<aside class="dates">2018-11-25</aside></a></li><li><a href="/archive/dwh72kammfl/">怎么去控制浏览器对资源文件的处理行为<aside class="dates">2018-11-25</aside></a></li></ul></section></div><footer id="footer"><div class="footer-left">Copyright © 2018 Fan <a href="http://www.miitbeian.gov.cn" rel="external nofollow noopener noreferrer" target="_blank">浙ICP备18045521号</a></div><div class="footer-right"><nav><ul><li><a href="/">Home</a></li><li><a href="/archive/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="http://github.com/Fantasy9527" target="_blank">Github</a></li></ul></nav></div></footer><script src="https://alili.tech/lib/justified-gallery/jquery.justifiedGallery.min.js"></script><script src="https://alili.tech/lib/typed.js"></script><script src="https://alili.tech/js/main.js"></script><script async src=""></script><script>!function(){if("alili.tech"===location.host){var t=document.createElement("script");window.location.protocol.split(":")[0];t.src="https://www.googletagmanager.com/gtag/js?id=UA-129382678-1";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(t,a),window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","UA-129382678-1")}function e(){dataLayer.push(arguments)}}()</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>